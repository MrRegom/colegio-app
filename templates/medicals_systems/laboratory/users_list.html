{% extends 'partials/base.html' %}
{% load static %}
{% block title %}Gestión de Usuarios{% endblock title %}

{% block extra_css %}
<!-- Sweet Alert css-->
<link href="{% static 'libs/sweetalert2/sweetalert2.min.css' %}" rel="stylesheet" type="text/css" />
<!-- List.js + Pagination CSS -->
<link href="{% static 'libs/list.js/list.pagination.css' %}" rel="stylesheet" type="text/css" />
<!-- Dropzone css -->
<link href="{% static 'libs/dropzone/dropzone.css' %}" rel="stylesheet" type="text/css" />

<style>
    .border-dashed {
        border-style: dashed !important;
    }
    .dropzone .dz-message {
        font-size: 16px;
    }
</style>
{% endblock extra_css %}

{% block main_title %}
<div class="page-title-box">
    <div class="row align-items-center">
        <div class="col-md-8">
            {% block pagetitle %}
                {% include "partials/page-title.html" with pagetitle="Laboratorio" title="Usuarios" %}
            {% endblock pagetitle %}
        </div><!--end col-->
        <div class="col-md-4">
            <div class="d-flex gap-2 justify-content-end">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#importarUsuariosModal">
                    <i class="ri-upload-2-line align-bottom"></i> Importar
                </button>
                <a href="{% url 'medicals_systems:user_create' %}" class="btn btn-success">
                    <i class="ri-add-line align-bottom"></i> Nuevo Usuario
                </a>
            </div>
        </div><!--end col-->
    </div><!--end row-->
</div>
{% endblock main_title %}

{% block content %}
<!-- Tabla de usuarios -->
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <h5 class="card-title mb-0 flex-grow-1">Lista de Usuarios</h5>
                <div class="flex-shrink-0">
                    <div class="d-flex flex-wrap gap-2">
                        <div class="search-box">
                            <input type="text" class="form-control search" placeholder="Buscar usuario...">
                            <i class="ri-search-line search-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-nowrap" id="usuarioTable">
                        <thead>
                            <tr>
                                <th class="sort" data-sort="id">#</th>
                                <th class="sort" data-sort="rut">RUT</th>                                
                                <th class="sort" data-sort="nombre_completo">Nombre Completo</th>
                                <th class="sort" data-sort="email">Email</th>
                                <th class="sort" data-sort="usuario">Usuario</th>
                                <th class="sort" data-sort="sistemas_registrados">Sistemas</th>
                                <th class="sort" data-sort="pin">Pin</th>
                                <th class="sort" data-sort="servicios">Servicios</th>                                
                                <th class="sort" data-sort="fecha_creacion">Fecha Creación</th>
                                <th class="sort" data-sort="fecha_expiracion">Fecha Expiración</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="list">
                            {% for usuario in page_obj %}
                            <tr>
                                <td class="id">{{ usuario.id }}</td>
                                <td class="rut">{{ usuario.rut }}</td>
                                <td class="nombre_completo">{{ usuario.nombre_completo }}</td>
                                <td class="email">{{ usuario.email }}</td>
                                <td class="usuario">{{ usuario.usuario }}</td>
                                <td class="sistemas_registrados">{{ usuario.sistemas_registrados|default:"-" }}</td>
                                <td class="pin">{{ usuario.pin }}</td>
                                <td class="servicios">
                                    {% if usuario.servicios and usuario.servicios.servicios %}
                                        <span class="d-inline-flex flex-wrap gap-1">
                                            {% for servicio_id in usuario.servicios.servicios %}
                                                <span class="badge bg-primary-subtle text-primary servicio-badge" data-id="{{ servicio_id }}">
                                                    Cargando...
                                                </span>
                                            {% endfor %}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="fecha_creacion">{{ usuario.fecha_creacion|date:"d-m-Y" }}</td>
                                <td class="fecha_expiracion">{{ usuario.fecha_expiracion|date:"d-m-Y"|default:"-" }}</td>
                                <td class="text-center">
                                    <div class="d-flex gap-2 justify-content-center">
                                        <a href="{% url 'medicals_systems:user_detail' usuario.id %}" class="btn btn-sm btn-info" title="Ver detalles">
                                            <i class="ri-eye-fill"></i>
                                        </a>
                                        <a href="{% url 'medicals_systems:user_edit' usuario.id %}" class="btn btn-sm btn-primary" title="Editar">
                                            <i class="ri-pencil-fill"></i>
                                        </a>
                                        <a href="{% url 'medicals_systems:user_delete' usuario.id %}" class="btn btn-sm btn-danger" title="Eliminar">
                                            <i class="ri-delete-bin-fill"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="11" class="text-center">No hay usuarios registrados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginación -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        Mostrando {{ page_obj.start_index }} a {{ page_obj.end_index }} de {{ total_usuarios }} usuarios
                    </div>
                    <div class="pagination-container">
                        <ul class="pagination pagination-separated justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a href="?page=1" class="page-link"><i class="ri-arrow-left-double-line"></i></a>
                            </li>
                            <li class="page-item">
                                <a href="?page={{ page_obj.previous_page_number }}" class="page-link"><i class="ri-arrow-left-line"></i></a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a href="#" class="page-link"><i class="ri-arrow-left-double-line"></i></a>
                            </li>
                            <li class="page-item disabled">
                                <a href="#" class="page-link"><i class="ri-arrow-left-line"></i></a>
                            </li>
                            {% endif %}

                            {% for i in page_obj.paginator.page_range %}
                                {% if i == page_obj.number %}
                                <li class="page-item active">
                                    <a href="?page={{ i }}" class="page-link">{{ i }}</a>
                                </li>
                                {% elif i > page_obj.number|add:"-3" and i < page_obj.number|add:"3" %}
                                <li class="page-item">
                                    <a href="?page={{ i }}" class="page-link">{{ i }}</a>
                                </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a href="?page={{ page_obj.next_page_number }}" class="page-link"><i class="ri-arrow-right-line"></i></a>
                            </li>
                            <li class="page-item">
                                <a href="?page={{ page_obj.paginator.num_pages }}" class="page-link"><i class="ri-arrow-right-double-line"></i></a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a href="#" class="page-link"><i class="ri-arrow-right-line"></i></a>
                            </li>
                            <li class="page-item disabled">
                                <a href="#" class="page-link"><i class="ri-arrow-right-double-line"></i></a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Importar Usuarios -->
<div class="modal fade" id="importarUsuariosModal" tabindex="-1" aria-labelledby="importarUsuariosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importarUsuariosModalLabel">Importar Usuarios</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="ri-file-upload-line display-4 text-primary"></i>
                    <h5 class="mt-3">Cargue un archivo CSV o Excel con los datos de los usuarios</h5>
                </div>
                
                <div class="alert alert-info mb-4">
                    <h6 class="alert-heading fw-semibold"><i class="ri-information-line me-1 align-middle"></i> Instrucciones:</h6>
                    <p class="mb-2">El archivo debe contener las siguientes columnas:</p>
                    <ul class="mb-0">
                        <li>RUT</li>
                        <li>Nombre Completo</li>
                        <li>Email</li>
                        <li>Usuario</li>
                        <li>Sistemas Registrados</li>
                        <li>PIN</li>
                        <li>Servicios (separados por comas, ej: "medicina_interna,cardiologia,urgencias_adulto")</li>
                        <li>Fecha Expiración (formato: DD/MM/AAAA)</li>
                        <li>Observaciones</li>
                    </ul>
                </div>
                
                <form id="importForm" enctype="multipart/form-data" method="post" action="{% url 'medicals_systems:user_import' %}">
                    {% csrf_token %}
                    <div class="dropzone border-dashed border-2 rounded p-4 mb-4" id="fileDropzone">
                        <div class="fallback">
                            <input name="file" type="file" accept=".csv, .xlsx, .xls">
                        </div>
                        <div class="dz-message needsclick text-center">
                            <div class="mb-3">
                                <i class="display-6 text-muted ri-upload-cloud-2-line"></i>
                            </div>
                            
                            <h5 class="fs-16">Arrastre y suelte el archivo aquí o haga clic para seleccionar</h5>
                            <span class="text-muted">(Solo se permiten archivos CSV, XLS o XLSX)</span>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btnImportarUsuarios">Importar Usuarios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<!-- List.js min js -->
<script src="{% static 'libs/list.js/list.min.js' %}"></script>
<script src="{% static 'libs/list.pagination.js/list.pagination.min.js' %}"></script>

<!-- Sweet Alert js -->
<script src="{% static 'libs/sweetalert2/sweetalert2.min.js' %}"></script>

<!-- Dropzone js -->
<script src="{% static 'libs/dropzone/dropzone-min.js' %}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Inicialización de List.js
        var options = {
            valueNames: [
                'id', 
                'rut',                
                'nombre_completo', 
                'email', 
                'usuario', 
                'sistemas_registrados',
                'pin',
                'servicios',
                'fecha_creacion',
                'fecha_expiracion'
            ],
            page: 10,
            pagination: true
        };

        var usuarioList = new List('usuarioTable', options);

        // Cargar nombres de servicios
        const servicioBadges = document.querySelectorAll('.servicio-badge');
        const servicioIds = Array.from(servicioBadges).map(badge => badge.dataset.id);
        
        if (servicioIds.length > 0) {
            // Obtener todos los servicios necesarios en una sola solicitud
            fetch(`/medicals_systems/api/servicios/?ids=${servicioIds.join(',')}`)
                .then(response => response.json())
                .then(data => {
                    // Actualizar cada badge con el nombre correspondiente
                    servicioBadges.forEach(badge => {
                        const servicioId = badge.dataset.id;
                        const servicio = data.servicios.find(s => s.id === parseInt(servicioId));
                        if (servicio) {
                            badge.textContent = servicio.nombre_servicio;
                        } else {
                            badge.textContent = `ID: ${servicioId}`;
                        }
                    });
                })
                .catch(error => {
                    console.error('Error al cargar servicios:', error);
                    // En caso de error, mostrar solo los IDs
                    servicioBadges.forEach(badge => {
                        badge.textContent = `ID: ${badge.dataset.id}`;
                    });
                });
        }

        // Configuración de Dropzone
        Dropzone.autoDiscover = false;
        
        var myDropzone = new Dropzone("#fileDropzone", {
            url: "#", // Se sobrescribirá con la acción del formulario
            autoProcessQueue: false,
            maxFiles: 1,
            acceptedFiles: ".csv,.xlsx,.xls",
            addRemoveLinks: true,
            dictRemoveFile: "Eliminar",
            dictDefaultMessage: "Arrastre y suelte el archivo aquí o haga clic para seleccionar",
            dictFileTooBig: "El archivo es demasiado grande",
            dictInvalidFileType: "No puede cargar archivos de este tipo",
            dictResponseError: "El servidor respondió con un código {{statusCode}}",
            dictCancelUpload: "Cancelar carga",
            dictUploadCanceled: "Carga cancelada",
            dictCancelUploadConfirmation: "¿Está seguro de que desea cancelar esta carga?",
            dictRemoveFileConfirmation: null,
            dictMaxFilesExceeded: "No puede cargar más archivos",
            init: function() {
                var myDropzone = this;
                
                // Manipulación del envío de formulario
                document.getElementById("importForm").addEventListener("submit", function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (myDropzone.files.length > 0) {
                        // Mostrar indicador de carga
                        Swal.fire({
                            title: "Procesando...",
                            text: "Estamos importando los usuarios, por favor espere...",
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            showConfirmButton: false,
                            willOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        // Preparar y enviar el formulario con AJAX
                        var formData = new FormData(this);
                        formData.append('file', myDropzone.files[0]);
                        
                        fetch(this.action, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                Swal.fire({
                                    title: "¡Importación completada!",
                                    text: data.message,
                                    icon: "success",
                                    confirmButtonText: "Aceptar"
                                }).then(function() {
                                    // Recargar la página para mostrar los nuevos usuarios
                                    window.location.reload();
                                });
                            } else {
                                let errorMsg = data.message;
                                if (data.errors && data.errors.length > 0) {
                                    errorMsg += " Detalles de los errores: " + data.errors.join(", ");
                                }
                                Swal.fire({
                                    title: "Error",
                                    text: errorMsg,
                                    icon: "error",
                                    confirmButtonText: "Aceptar"
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire({
                                title: "Error",
                                text: "Ha ocurrido un error en la comunicación con el servidor.",
                                icon: "error",
                                confirmButtonText: "Aceptar"
                            });
                        })
                        .finally(() => {
                            $('#importarUsuariosModal').modal('hide');
                            myDropzone.removeAllFiles(true);
                        });
                    } else {
                        Swal.fire({
                            title: "Error",
                            text: "Por favor, seleccione un archivo para importar.",
                            icon: "error",
                            confirmButtonText: "Aceptar"
                        });
                    }
                });
                
                // Eventos de Dropzone
                this.on("addedfile", function(file) {
                    console.log("Archivo añadido:", file.name);
                });
                
                this.on("removedfile", function(file) {
                    console.log("Archivo eliminado:", file.name);
                });
                
                this.on("error", function(file, errorMessage) {
                    console.error("Error con el archivo:", errorMessage);
                    Swal.fire({
                        title: "Error",
                        text: "Ha ocurrido un error al cargar el archivo: " + errorMessage,
                        icon: "error",
                        confirmButtonText: "Aceptar"
                    });
                });
            }
        });

        // Mostrar mensajes de éxito o error
        {% if messages %}
            {% for message in messages %}
                Swal.fire({
                    title: '{{ message.tags|title }}',
                    text: '{{ message }}',
                    icon: '{% if message.tags == "error" %}error{% else %}success{% endif %}',
                    confirmButtonText: 'Aceptar'
                });
            {% endfor %}
        {% endif %}
    });
</script>
{% endblock extra_js %} 