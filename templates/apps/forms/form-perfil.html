{% extends 'partials/base.html' %}
{% load static %}
{% block title %} Formularios | Solicitud de Perfiles {% endblock title %} 

{% block extra_css %}
<!-- Sweet Alert css-->
<link href="{% static 'libs/sweetalert2/sweetalert2.min.css' %}" rel="stylesheet" type="text/css" />
<!-- Custom CSS (incluye estilos del lector de huellas) -->
<link href="{% static 'css/custom.css' %}" rel="stylesheet" type="text/css" />
{% endblock extra_css %}

{% block main_title %} 

<div class="page-title-box">
    <div class="row align-items-center">
        <div class="col-md-5">
            {% block pagetitle %}
                {% include "partials/page-title.html" with pagetitle="Formularios" title="Solicitud de Perfiles" %}
            {% endblock pagetitle %}
        </div><!--end col-->
    </div><!--end row-->
</div>
{% endblock main_title %}

{% block content %}

<!-- Banner para el título del formulario -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card bg-primary">
            <div class="card-body text-center text-white py-4">
                <h2 class="mb-2">Formulario de Solicitud de Perfiles</h2>
                <p class="mb-0">Este documento es solicitado por la jefatura a cargo, quien se hará cargo completamente de los accesos solicitados al usuario en cuestión.</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <div class="flex-grow-1">
                    <h4 class="card-title mb-1">Datos del Usuario</h4>
                    <p class="text-muted mb-0">Ingrese los datos completos del usuario que requiere acceso a los sistemas.</p>
                </div>
            </div><!-- end card header -->
            <div class="card-body tab-content">
                <div class="tab-pane show active" id="floatingFormsPreview" role="tabpanel" aria-labelledby="floatingFormsPreview-tab" tabindex="0">
                    <form id="profileRequestForm" class="needs-validation" novalidate method="post" action="{% url 'crear_solicitud_perfil' %}">
                        {% csrf_token %}
                        <div class="row g-3">
                            <div class="col-lg-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="firstnamefloatingInput" name="firstnamefloatingInput" placeholder="Ingrese sus Nombres" required>
                                    <label for="firstnamefloatingInput">Nombres</label>
                                    <div class="invalid-feedback">
                                        Por favor ingrese los nombres.
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="lastnamefloatingInput" name="lastnamefloatingInput" placeholder="Ingrese sus Apellidos" required>
                                    <label for="lastnamefloatingInput">Apellidos</label>
                                    <div class="invalid-feedback">
                                        Por favor ingrese los apellidos.
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="rutfloatingInput" name="rutfloatingInput" placeholder="Ingrese su número de RUT" required>
                                    <label for="rutfloatingInput">RUT</label>
                                    <div class="invalid-feedback">
                                        Por favor ingrese el RUT.
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-floating">
                                    <input type="email" class="form-control" id="emailfloatingInput" name="emailfloatingInput" placeholder="Ingrese su correo electrónico" required>
                                    <label for="emailfloatingInput">Correo Electrónico</label>
                                    <div class="invalid-feedback">
                                        Por favor ingrese un correo electrónico válido.
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="unidadfloatingInput1" name="unidadfloatingInput1" placeholder="Ingrese la Unidad" required>
                                    <label for="unidadfloatingInput1">Unidad</label>
                                    <div class="invalid-feedback">
                                        Por favor ingrese la unidad.
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="estamentofloatingInput" name="estamentofloatingInput" placeholder="Ingrese el Estamento" required>
                                    <label for="estamentofloatingInput">Estamento</label>
                                    <div class="invalid-feedback">
                                        Por favor ingrese el estamento.
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="cargofloatingInput" name="cargofloatingInput" placeholder="Ingrese el Cargo" required>
                                    <label for="cargofloatingInput">Cargo</label>
                                    <div class="invalid-feedback">
                                        Por favor ingrese el cargo.
                                    </div>
                                </div>
                            </div>
                            <div class="card-header d-md-flex gap-3">
                                <div class="flex-grow-1">
                                    <h4 class="card-title mb-1">Datos de la Jefatura</h4>
                                        <p class="text-muted mb-0">Este documento es solicitado por la jefatura a cargo, quien se hará cargo completamente de los accesos solicitados al usuario en cuestión.</p>
                                    </div>
                            </div><!-- end card header -->  
                            <div class="col-lg-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="firstnameleadershipfloatingInput" name="firstnameleadershipfloatingInput" placeholder="Ingrese sus Nombres" required>
                                    <label for="firstnameleadershipfloatingInput">Nombres</label>
                                    <div class="invalid-feedback">
                                        Por favor ingrese los nombres de la jefatura.
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="lastnameleadershipfloatingInput" name="lastnameleadershipfloatingInput" placeholder="Ingrese sus Apellidos" required>
                                    <label for="lastnameleadershipfloatingInput">Apellidos</label>
                                    <div class="invalid-feedback">
                                        Por favor ingrese los apellidos de la jefatura.
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="rutleadershipfloatingInput" name="rutleadershipfloatingInput" placeholder="Ingrese su número de RUT" required>
                                    <label for="rutleadershipfloatingInput">RUT</label>
                                    <div class="invalid-feedback">
                                        Por favor ingrese el RUT de la jefatura.
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-floating">
                                    <input type="email" class="form-control" id="emailleadershipfloatingInput" name="emailleadershipfloatingInput" placeholder="Ingrese su correo electrónico" required>
                                    <label for="emailleadershipfloatingInput">Correo Electrónico</label>
                                    <div class="invalid-feedback">
                                        Por favor ingrese un correo electrónico válido para la jefatura.
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="unidadleadershipfloatingInput1" name="unidadleadershipfloatingInput1" placeholder="Ingrese la Unidad" required>
                                    <label for="unidadleadershipfloatingInput1">Unidad</label>
                                    <div class="invalid-feedback">
                                        Por favor ingrese la unidad de la jefatura.
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="estamentoleadershipfloatingInput" name="estamentoleadershipfloatingInput" placeholder="Ingrese el Estamento" required>
                                    <label for="estamentoleadershipfloatingInput">Estamento</label>
                                    <div class="invalid-feedback">
                                        Por favor ingrese el estamento de la jefatura.
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="cargoleadershipfloatingInput" name="cargoleadershipfloatingInput" placeholder="Ingrese el Cargo" required>
                                    <label for="cargoleadershipfloatingInput">Cargo</label>
                                    <div class="invalid-feedback">
                                        Por favor ingrese el cargo de la jefatura.
                                    </div>
                                </div>
                            </div>
                            <div class="card-header d-md-flex gap-3">
                                <div class="flex-grow-1">
                                    <h4 class="card-title mb-1">Sistemas Requeridos</h4>
                                        <p class="text-muted mb-0">Seleccione los sistemas que requiere el usuario.</p>
                                    </div>
                            </div><!-- end card header -->  
                            <div class="col-md-4">
                                <div class="mt-4 mt-md-2">
                                    <div>
                                        <div class="form-check form-check-outline form-check-primary mb-3">
                                            <input class="form-check-input" type="checkbox" id="formCheck1" name="sistemas" value="HIS-SFERE">
                                            <label class="form-check-label" for="formCheck1">
                                                HIS - SFERE
                                            </label>
                                        </div>
                                        <div class="form-check form-check-outline form-check-secondary mb-3">
                                            <input class="form-check-input" type="checkbox" id="formCheck2" name="sistemas" value="SIH">
                                            <label class="form-check-label" for="formCheck2">
                                                SIH
                                            </label>
                                        </div>
                                        <div class="form-check form-check-outline form-check-success mb-3">
                                            <input class="form-check-input" type="checkbox" id="formCheck3" name="sistemas" value="TRAKCARE">
                                            <label class="form-check-label" for="formCheck3">
                                                TRAKCARE
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mt-4 mt-md-2">
                                    <div>
                                        <div class="form-check form-check-outline form-check-primary mb-3">
                                            <input class="form-check-input" type="checkbox" id="formCheck4" name="sistemas" value="Dedalus">
                                            <label class="form-check-label" for="formCheck4">
                                                Dedalus (Toma de muestras - DNLab)
                                            </label>
                                        </div>
                                        <div class="form-check form-check-outline form-check-secondary mb-3">
                                            <input class="form-check-input" type="checkbox" id="formCheck5" name="sistemas" value="Soporte-MDA">
                                            <label class="form-check-label" for="formCheck5">
                                                Soporte MDA | Proactivanet
                                            </label>
                                        </div>
                                        <div class="form-check form-check-outline form-check-success mb-3">
                                            <input class="form-check-input" type="checkbox" id="formCheck6" name="sistemas" value="Mi-Ssvq">
                                            <label class="form-check-label" for="formCheck6">
                                                Mi Ssvq (Gestor documental)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--end col-->  

                            <div class="card-header d-md-flex gap-3">
                                <div class="flex-grow-1">
                                    <h4 class="card-title mb-1">Información Adicional</h4>
                                        <p class="text-muted mb-0">Ingrese la información adicional que considere necesaria.</p>
                                    </div>
                            </div><!-- end card header -->  

                            <div class="row mb-3 mt-4 mt-md-2">
                                <div class="col-lg-3">
                                    <label for="permisosInput" class="form-label">¿Que permisos necesita? ¿Qué labores desempeña?</label>
                                </div>
                                <div class="col-lg-9">
                                    <textarea class="form-control" id="permisosInput" name="permisos" rows="3" placeholder="Describa los permisos que necesita y las labores que desempeña"></textarea>
                                </div>
                            </div>                            
                            <div class="row mb-3">
                                <div class="col-lg-3">
                                    <label for="homologacionInput" class="form-label">¿Necesita homologar los accesos a los de otro usuario?</label>
                                </div>
                                <div class="col-lg-9">
                                    <textarea class="form-control" id="homologacionInput" name="homologacion" rows="3" placeholder="Indique si necesita homologar accesos y de qué usuario"></textarea>
                                </div>
                            </div>
                            
                            <!-- Firma Digital -->
                            <div class="col-lg-12">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <!-- Contenedor para la huella digital -->
                                        <div id="fingerprintContainer" class="fingerprint-container">
                                            <h5 class="text-center mb-3">Verificación de Huella Digital</h5>
                                            
                                            <div class="fingerprint-image-container" id="fingerprintScanArea">
                                                <div class="fingerprint-base"></div>
                                                <div class="fingerprint-scan"></div>
                                                <div class="fingerprint-overlay"></div>
                                                <div class="scanning-instruction">Coloque su dedo índice en el lector</div>
                                            </div>
                                            
                                            <div class="progress-indicator">
                                                <div class="progress-bar"></div>
                                            </div>
                                            
                                            <div class="fingerprint-status" id="fingerprintStatus">Esperando huella digital...</div>
                                            <input type="hidden" id="fingerprintData" name="fingerprintData">
                                            
                                            <div class="text-center mt-3">
                                                <button type="button" id="cancelFingerprint" class="btn btn-light btn-sm">Cancelar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-end mt-4">
                                    <button type="button" id="leadershipSignature" class="btn btn-secondary me-2">Firma de Jefatura</button>
                                    <button type="submit" id="submitToLeadership" class="btn btn-primary">Enviar a Jefatura</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div><!--end col-->
</div><!--end row-->
{% endblock content %}

{% block extra_js %}
<!-- Sweet Alert -->
<script src="{% static 'libs/sweetalert2/sweetalert2.min.js' %}"></script>

<!-- Servicio de huellas digitales -->
<script src="{% static 'js/apps/digital-persona.js' %}"></script>

<!-- Formulario de perfil -->
    <script src="{% static 'js/apps/form-perfil.js' %}"></script>
    <!-- Fallback stub: garantiza que window.submitProfileForm exista aun si form-perfil.js no se cargó correctamente -->
    <script>
        if (typeof window.submitProfileForm !== 'function') {
            window.submitProfileForm = function() {
                console.warn('Fallback submitProfileForm invoked: form-perfil.js not loaded or failed.');
                const formEl = document.getElementById('profileRequestForm');
                if (!formEl) return Promise.reject(new Error('Formulario no encontrado'));
                const formData = new FormData(formEl);
                return fetch('/solicitudes-perfil/crear/', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(resp => {
                    try { return resp.json(); } catch (e) { return Promise.reject(e); }
                })
                .then(json => {
                    if (json && json.success) {
                        console.log('Fallback: solicitud enviada con éxito');
                        window.location.href = '/solicitudes-perfil/lista/';
                    } else {
                        console.error('Fallback: error al guardar solicitud', json);
                        alert(json && json.message ? json.message : 'No se pudo guardar la solicitud');
                    }
                    return json;
                })
                .catch(err => {
                    console.error('Fallback: error en el envío:', err);
                    throw err;
                });
            };
        }
    </script>

<!-- Formularios JS -->
<script src="{% static 'js/pages/forms.init.js' %}"></script>
{% endblock extra_js %}
